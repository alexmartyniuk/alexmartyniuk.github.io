<!DOCTYPE html><html lang="uk" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="pv-cache-enabled" content="false"><title> Транзакції в NoSQL. Погляд на DynamoDB з позиції C# | Мартинюк Олександр</title><link rel="shortcut icon" href="/uk/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/uk/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/uk/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/uk/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/uk/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/uk/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/uk/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/uk/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/uk/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/uk/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/uk/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/uk/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/uk/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/uk/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/uk/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/uk/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/uk/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/uk/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/uk/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/uk/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"> <script src="/assets/js/dist/lang-detector.js"></script> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-166067964-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-166067964-1'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/sample/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Мартинюк Олександр</a></div><div class="site-subtitle font-italic">Програміст .NET</div><div class="site-title mt-0"> <a href="/posts/%D1%82%D1%80%D0%B0%D0%BD%D0%B7%D0%B0%D0%BA%D1%86%D1%96%D1%97-%D0%B2-dynamodb/" title="In English"> <img src="/assets/img/sample/english.png" width="40px" height="40px"/> </a></div></div><ul class="w-100"><li class="nav-item"> <a href="/uk/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>СТАТТІ</span> </a><li class="nav-item"> <a href="/uk/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>КАТЕГОРІЇ</span> </a><li class="nav-item"> <a href="/uk/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>ТЕГИ</span> </a><li class="nav-item"> <a href="/uk/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>АРХІВ</span> </a><li class="nav-item"> <a href="/uk/projects/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ПРОЄКТИ</span> </a><li class="nav-item"> <a href="/uk/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ПРО МЕНЕ</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/alexmartyniuk" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/alexmartyniuk" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['alexander.martinyuk','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span></span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Транзакції в NoSQL. Погляд на DynamoDB з позиції C#</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Tue, Sep 29, 2020, 12:00 AM +0300" > Sep 29, 2020 <i class="unloaded">2020-09-29T00:00:00+03:00</i> </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1904 words">10 min</span></div></div><div class="post-content"><h1 id="nosql-проти-sql">NoSQL проти SQL</h1><p>На протязі багатьох років в розробці програмного забезпечення домінували реляційні бази даних. SQL стала однією з найпоширеніших мов програмування, а інженери що знали як правильно спроектувати і підтримувати роботу таких БД відокремились в окрему касту і стали називатись адміністратори БД або DBA. Після десятиліть розвитку SQL бази даних стали надійним інструментом при реалізації найрізноманітнішого роду програм, які вимагали строгої узгодженості даних. Це стало можливим завдяки транзакціям, тригерам та об’єднанню даних (join) на рівні БД. Але на початку 20 століття розвиток WEB 2.0 і потреби таких компаній як Google, Facebook і Amazon спричинили революцію в збереженні даних. Сувора узгодженість і можливості внутрішнього об’єднання відступили під вимогами високої доступності, швидкості та горизонтального масштабування. З’явились такі СУБД як Neo4j, Memcached, Redis, MongoDB, Cassandra і Amazon DynamoDB. Вони призначались для збереження не структурованих даних в кластерних системах і сувора узгодженість тут не завжди була потрібна. З часом сформувалась стійка думка, що NoSQL бази даних - це для не впорядкованих даних великих розмірів, що необхідно розподіляти по багатьох серверах і швидко знаходити за простими запитами на основі відповідності ключа. В той час як SQL - це для структурованих даних, які пов’язані відношеннями і повинні бути суворо узгодженими завдяки механізму транзакцій. Таке розділення способів зберігання даних призвело до породження специфічних підходів до проектування різних програмних систем. Програмісту чи архітектору перед тим як намалювати схему системи і включити в неї ту чи іншу БД необхідно було вирішити чи потрібна підсистемі зберігання даних сувора узгодженість. Що важливіше - ACID чи висока доступність та швидкість роботи з даними? Така ситуація тривала деякий час, аж поки в NoSQL базах даних не з’явились транзакції.</p><p>В цій статті я розкажу про транзакції в одній з перших NoSQL баз даних - Amazon DynamoDB. Подивимось чим вони відрізняються від транзакцій в SQL, в яких випадках варто будувати програми з їх використанням і як працювати з ними за допомогою C# та .NET Core.</p><h1 id="dynamodb">DynamoDB</h1><p>Для початку познайомимось з деякими концептами цієї бази даних. DynamoDB - документна база даних без схеми. Вона зберігає дані в таблицях, кожна з яких може розміщуватись на декількох серверах, розподіляючи таким чином навантаження. Це дозволяє DynamoDB оброблят мільйони запитів за секунду в пікові періоди і масштабуватись практично необмежено.</p><p>Для представлення документів DynamoDB використовує формат JSON. Створення таблиці вимагає лише трьох аргументів: імені таблиці, ключа та списку атрибутів, серед яких повинен бути атрибут, що використовується як ключ секції. Ключ секції (Partition Key) використовується для визначення фізичного розміщення запису. Ключ секції разом з необов’язковим ключем сортування (Sort Key або Range Key) створюють первісний ключ, що дозволяє унікально ідентифікувати запис в таблиці DynamoDB.</p><p>Тоді як реляційні бази даних пропонують досить потужну мову запитів SQL, DynamoDB пропонує лише операції Put, Get, Update та Delete на одиночних таблицях і взагалі пне ропонує будь яких об’єднань таблиць в запитах. Через цю простоту DynamoDB дуже добре масштабується і має практично необмежену пропускну здатність.</p><p>Ще однією особливістю БД є те, що її використання тарифікується не за місцем, яке займають дані, а за пропускною здатністю, що вимірюється так званими RCU та WCU. RCU (read capacity unit) - це одиниця, що відповідає одному запиту на читання до 4 Kb даних. WCU (write capacity unit) - аналогічно для запису, тільки ліміт даних для одного WCU 1 Kb.</p><p>Давайте спробуємо запустити DynamoDB локально і виконати прості запити на читання і запис даних.</p><p>Для роботи нам знадобляться Docker, .NET Core SDK, командний рядок та редактор коду, наприклад VSCode. Amazon пропонує локальну версію DynamoDB, яка повністю підтримує транзакції і нам цього достатньо. Тому акаунт AWS нам не потрібен, ми все будемо робити на локальному комп’ютері.</p><p>Відкриємо консоль і запустимо команду:</p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="err">&gt;</span><span class="w"> </span><span class="n">docker</span><span class="w"> </span><span class="nx">run</span><span class="w"> </span><span class="nt">-p</span><span class="w"> </span><span class="nx">8000:8000</span><span class="w"> </span><span class="nx">amazon/dynamodb-local</span><span class="w">

</span><span class="o">...</span><span class="w">
</span><span class="n">Initializing</span><span class="w"> </span><span class="nx">DynamoDB</span><span class="w"> </span><span class="nx">Local</span><span class="w"> </span><span class="nx">with</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">following</span><span class="w"> </span><span class="nx">configuration:</span><span class="w">
</span><span class="n">Port:</span><span class="w">   </span><span class="nx">8000</span><span class="w">
</span><span class="n">InMemory:</span><span class="w">       </span><span class="nx">true</span><span class="w">
</span><span class="n">DbPath:</span><span class="w"> </span><span class="nx">null</span><span class="w">
</span><span class="n">SharedDb:</span><span class="w">       </span><span class="nx">false</span><span class="w">
</span><span class="n">shouldDelayTransientStatuses:</span><span class="w">   </span><span class="nx">false</span><span class="w">
</span><span class="n">CorsParams:</span><span class="w">     </span><span class="o">*</span><span class="w">
</span></pre></table></code></div></div><p>Docker завантжив образ dynamodb-local і запустив сервіс на порту 8000. Тепер ми можемо звернутись до бази даних за адресою http://localhost:8000. Дані будуть збережені в пам’яті, про що свідчить параметр <code class="language-plaintext highlighter-rouge">InMemory: true</code>, тому DbPath (шлях до файлу даних) порожній. Якщо ви бажаєте зберігати дані на диску між запусками контейнеру вам необхідно вказати параметри <code class="language-plaintext highlighter-rouge">-sharedDB</code> та <code class="language-plaintext highlighter-rouge">-dbPath</code>. <a href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/DynamoDBLocal.UsageNotes.html">Детальніше</a></p><p>Перед тим як створити першу таблицю, давайте опишемо предметну область, яку ми будемо моделювати.</p><h1 id="система-замовлення-таксі">Система замовлення таксі</h1><p>Нехай у нас є система замовлення таксі. Є клієнт, водій і власне замовлення. Опишемо деякі вимоги до нашої системи.</p><ol><li>Клієнт замовляє поїздку, створюючи замовлення.<li>Водій автомобіля приймає замовлення до роботи.<li>Після доставки клієнта водій позначає замовлення виконаним.<li>Водій не може прийняти замовлення, яке вже в роботі.<li>Клієнт не може замовити більше однієї поїздки одночасно.</ol><p>Це дуже спрощена схема роботи таких сервісів, як Uber або Uklon. Звісно, можна придумати набагато більше вимог до такої системи, але для нас зараз вони не важливі. Нам важливо продемонструвати <strong>ідемпотентність</strong>, <strong>узгодженність</strong> та <strong>атомарність</strong> операцій, та як саме це може бути реалізованим з DynamoDB. Отже, які таблиці нам знадобляться в базі даних?</p><p>Нам потрібний клієнт. Будь яка таблиця DynamoDB повинна містити унікальний ключ, нехай це буде телефонний номер клієнта. Також таблиця буде містити поточне замовлення цього клієнту. Якщо поле замовлення порожнє - замовлень немає.</p><div class="table-wrapper"><table><thead><tr><th>Client<tbody><tr><td>Id<tr><td>OrderId</table></div><p>У водія все схоже, тільки як унікальний ідентифікатор візьмемо номер машини. Так як модель водія дуже схожа на модель клієнта, то чому б нам не записати їх в одну таблицю?</p><div class="table-wrapper"><table><thead><tr><th>Taxi<tbody><tr><td>Id<tr><td>OrderId</table></div><p>В замовленні будуть міститись ідентифікатори водія, клієнта і статус замовлення: Pending, InProgress, Done.</p><div class="table-wrapper"><table><thead><tr><th>Taxi<tbody><tr><td>Id<tr><td>OrderId<tr><td>ClientId<tr><td>DriverId<tr><td>OrderStatus</table></div><p>Уявімо що в системі існує клієнт, водій та замовлення від клієнту, яке в знаходиться в статусі очікування.</p><p>Для тих розробників, які багато працювали з SQL така універсальна таблиця, що містить все на світі може здатись дивною і не правильно. Їм відразу захочеться розбити її і провести нормалізацію. Але у світі NoSQL це абсолютно звична річ. Такі таблиці називаються <em>гомогенними</em>. DynamoDB не буде марнувати місце на диску для збереження порожніх полів записів, адже вона збергіає документи, або колекції атрибутів. Просто в колекції атрибутів для записів клієнта та водія будуть відсутніми ClientId, DriverId та OrderStatus, а для замовлень буде відсутнім атрибут OrderId. Крім того, сам Amazon рекомендує використовувати гомогенні таблиці в DynamoDB. Їх рекомендація - <a href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/bp-general-nosql-design.html#bp-general-nosql-design-concepts">тримати пов’язані дані якомога ближче і мати якнайменше таблиць</a>.</p><p>Створимо консольну програму в .NET Core та додамо пакет для роботи з DynamoDB API - <code class="language-plaintext highlighter-rouge">AWSSDK.DynamoDBv2</code></p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="err">&gt;</span><span class="w"> </span><span class="n">dotnet</span><span class="w"> </span><span class="nx">new</span><span class="w"> </span><span class="nx">console</span><span class="w">
</span><span class="o">...</span><span class="w">
</span><span class="n">Restore</span><span class="w"> </span><span class="nx">succeeded.</span><span class="w">

</span><span class="err">&gt;</span><span class="w"> </span><span class="n">dotnet</span><span class="w"> </span><span class="nx">add</span><span class="w"> </span><span class="nx">package</span><span class="w"> </span><span class="nx">AWSSDK.DynamoDBv2</span><span class="w">
</span><span class="n">info</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">PackageReference</span><span class="w"> </span><span class="nx">for</span><span class="w"> </span><span class="nx">package</span><span class="w"> </span><span class="s1">'AWSSDK.DynamoDBv2'</span><span class="w"> </span><span class="nx">version</span><span class="w"> </span><span class="s1">'3.5.0.22'</span><span class="w"> </span><span class="nx">added</span><span class="w"> </span><span class="o">...</span><span class="w">
</span><span class="o">...</span><span class="w">
</span></pre></table></code></div></div><p>У файлі <code class="language-plaintext highlighter-rouge">Program.cs</code> зконфігуруємо клінта для роботи з локальною базою даних і додамо метод для створення таблиці:</p><div class="language-c# highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre><td class="rouge-code"><pre>
<span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">AmazonDynamoDBClient</span> <span class="n">client</span> <span class="p">=</span>
    <span class="k">new</span> <span class="nf">AmazonDynamoDBClient</span><span class="p">(</span><span class="k">new</span> <span class="n">AmazonDynamoDBConfig</span> <span class="p">{</span><span class="n">ServiceURL</span> <span class="p">=</span> <span class="s">"http://localhost:8000"</span><span class="p">});</span>

<span class="k">private</span> <span class="k">static</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">CreateTable</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">CreateTableAsync</span><span class="p">(</span><span class="k">new</span> <span class="n">CreateTableRequest</span>
    <span class="p">{</span>
        <span class="n">TableName</span> <span class="p">=</span> <span class="s">"Taxi"</span><span class="p">,</span>
        <span class="n">AttributeDefinitions</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">AttributeDefinition</span><span class="p">&gt;</span>
        <span class="p">{</span>
            <span class="k">new</span> <span class="n">AttributeDefinition</span>
            <span class="p">{</span>
                <span class="n">AttributeName</span> <span class="p">=</span> <span class="s">"Id"</span><span class="p">,</span>
                <span class="n">AttributeType</span> <span class="p">=</span> <span class="s">"S"</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="n">KeySchema</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">KeySchemaElement</span><span class="p">&gt;</span>
        <span class="p">{</span>
            <span class="k">new</span> <span class="n">KeySchemaElement</span>
            <span class="p">{</span>
                <span class="n">AttributeName</span> <span class="p">=</span> <span class="s">"Id"</span><span class="p">,</span>
                <span class="n">KeyType</span> <span class="p">=</span> <span class="s">"HASH"</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="n">ProvisionedThroughput</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ProvisionedThroughput</span>
        <span class="p">{</span>
            <span class="n">ReadCapacityUnits</span> <span class="p">=</span> <span class="m">5</span><span class="p">,</span>
            <span class="n">WriteCapacityUnits</span> <span class="p">=</span> <span class="m">5</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Єдиним атрибутом який ми визначили є Id типу String. В схемі визначено, що поле Id буде ключем секції. Також обов’язково необхідно вказати максимальну пропускну здатність, щоб DynamoDB знала як правильно масштабуватись. Для нас це не суттєво, нехай буде 5 одиниць за секунду для читання (RCU) і запису (WCU).</p><p>Додамо клієнта, водія та замовлення як показано в таблиці вище. Ці дані не узгоджені, тому використаємо звичайний <code class="language-plaintext highlighter-rouge">PutItem</code>, без транзакції.</p><div class="language-c# highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre><td class="rouge-code"><pre><span class="k">private</span> <span class="k">static</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">AddClientDriverAndOrder</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">PutItemAsync</span><span class="p">(</span><span class="k">new</span> <span class="n">PutItemRequest</span>
    <span class="p">{</span>
        <span class="n">TableName</span> <span class="p">=</span> <span class="s">"Taxi"</span><span class="p">,</span>
        <span class="n">Item</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">AttributeValue</span><span class="p">&gt;()</span>
        <span class="p">{</span>
            <span class="p">{</span> <span class="s">"Id"</span><span class="p">,</span> <span class="k">new</span> <span class="n">AttributeValue</span> <span class="p">{</span> <span class="n">S</span> <span class="p">=</span> <span class="s">"0993832478"</span> <span class="p">}},</span>
            <span class="p">{</span> <span class="s">"OrderId"</span><span class="p">,</span> <span class="k">new</span> <span class="n">AttributeValue</span> <span class="p">{</span> <span class="n">S</span> <span class="p">=</span> <span class="s">"{3e80b07d-e2e6-4310-8fda-851296a17a10}"</span> <span class="p">}}</span>
        <span class="p">}</span>
    <span class="p">});</span>

    <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">PutItemAsync</span><span class="p">(</span><span class="k">new</span> <span class="n">PutItemRequest</span>
    <span class="p">{</span>
        <span class="n">TableName</span> <span class="p">=</span> <span class="s">"Taxi"</span><span class="p">,</span>
        <span class="n">Item</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">AttributeValue</span><span class="p">&gt;()</span>
        <span class="p">{</span>
            <span class="p">{</span> <span class="s">"Id"</span><span class="p">,</span> <span class="k">new</span> <span class="n">AttributeValue</span> <span class="p">{</span> <span class="n">S</span> <span class="p">=</span> <span class="s">"АК9265АК"</span> <span class="p">}}</span>
        <span class="p">}</span>
    <span class="p">});</span>

    <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">PutItemAsync</span><span class="p">(</span><span class="k">new</span> <span class="n">PutItemRequest</span>
    <span class="p">{</span>
        <span class="n">TableName</span> <span class="p">=</span> <span class="s">"Taxi"</span><span class="p">,</span>
        <span class="n">Item</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">AttributeValue</span><span class="p">&gt;()</span>
        <span class="p">{</span>
            <span class="p">{</span> <span class="s">"Id"</span><span class="p">,</span> <span class="k">new</span> <span class="n">AttributeValue</span> <span class="p">{</span> <span class="n">S</span> <span class="p">=</span> <span class="s">"{3e80b07d-e2e6-4310-8fda-851296a17a10}"</span> <span class="p">}},</span>
            <span class="p">{</span> <span class="s">"ClientId"</span><span class="p">,</span> <span class="k">new</span> <span class="n">AttributeValue</span> <span class="p">{</span> <span class="n">S</span> <span class="p">=</span> <span class="s">"0993832478"</span> <span class="p">}},</span>
            <span class="p">{</span> <span class="s">"OrderStatus"</span><span class="p">,</span> <span class="k">new</span> <span class="n">AttributeValue</span> <span class="p">{</span><span class="n">S</span> <span class="p">=</span> <span class="s">"Pending"</span><span class="p">}}</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Спробуймо реалізувати якусь більш складну операцію, наприклад, “водій бере замовлення у роботу”. Для того, щоб водій взяв замовлення нам необхідно:</p><ul><li>оновити рядок замовлення: ** записати Id водія в поле Driver, якщо воно порожнє (водій не може взяти замовлення, яке вже виконується) ** записати InProgress в поле Status, якщо воно було Pending (водій не може взяти замовлення в будь якому іншому статусі окрім “Очікує виконання”)<li>оновити рядок водія: ** записати Id замовлення в поле Order, якщо воно порожнє (водій не може взяти одночасно два замовлення)</ul><p>Тобто, кінцевий результат повинен виглядати наступним чином:</p><p>Тут нам знадобиться ACID транзакція, адже оновити рядок замовлення і рядок водія потрібно синхронно. Якщо будь яка з перелічених вище умов не виконається, жодних змін в базі не має відбутися.</p><div class="language-c# highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre><td class="rouge-code"><pre><span class="k">private</span> <span class="k">static</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">DriverTakesOrder</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">TransactWriteItemsAsync</span><span class="p">(</span><span class="k">new</span> <span class="n">TransactWriteItemsRequest</span>
    <span class="p">{</span>
        <span class="n">TransactItems</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">TransactWriteItem</span><span class="p">&gt;</span>
        <span class="p">{</span>
            <span class="k">new</span> <span class="n">TransactWriteItem</span>
            <span class="p">{</span>
                <span class="n">Update</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Update</span>
                <span class="p">{</span>
                    <span class="n">TableName</span> <span class="p">=</span> <span class="s">"Taxi"</span><span class="p">,</span>
                    <span class="n">Key</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">AttributeValue</span><span class="p">&gt;</span>
                    <span class="p">{</span>
                        <span class="p">{</span> <span class="s">"Id"</span><span class="p">,</span> <span class="k">new</span> <span class="n">AttributeValue</span> <span class="p">{</span> <span class="n">S</span> <span class="p">=</span> <span class="s">"АК9265АК"</span> <span class="p">}}</span>
                    <span class="p">},</span>
                    <span class="n">UpdateExpression</span> <span class="p">=</span> <span class="s">"set OrderId = :OrderId"</span><span class="p">,</span>
                    <span class="n">ConditionExpression</span> <span class="p">=</span> <span class="s">"attribute_not_exists(OrderId)"</span><span class="p">,</span>
                    <span class="n">ExpressionAttributeValues</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">AttributeValue</span><span class="p">&gt;()</span>
                    <span class="p">{</span>
                        <span class="p">{</span><span class="s">":OrderId"</span><span class="p">,</span> <span class="k">new</span> <span class="n">AttributeValue</span> <span class="p">{</span> <span class="n">S</span> <span class="p">=</span> <span class="s">"{3e80b07d-e2e6-4310-8fda-851296a17a10}"</span><span class="p">}}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="k">new</span> <span class="n">TransactWriteItem</span>
            <span class="p">{</span>
                <span class="n">Update</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Update</span>
                <span class="p">{</span>
                    <span class="n">TableName</span> <span class="p">=</span> <span class="s">"Taxi"</span><span class="p">,</span>
                    <span class="n">Key</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">AttributeValue</span><span class="p">&gt;</span>
                    <span class="p">{</span>
                        <span class="p">{</span> <span class="s">"Id"</span><span class="p">,</span> <span class="k">new</span> <span class="n">AttributeValue</span> <span class="p">{</span> <span class="n">S</span> <span class="p">=</span> <span class="s">"{3e80b07d-e2e6-4310-8fda-851296a17a10}"</span> <span class="p">}}</span>
                    <span class="p">},</span>
                    <span class="n">UpdateExpression</span> <span class="p">=</span> <span class="s">"set DriverId = :DriverId, OrderStatus = :NewStatus"</span><span class="p">,</span>
                    <span class="n">ConditionExpression</span> <span class="p">=</span> <span class="s">"attribute_not_exists(DriverId) AND OrderStatus=:OldStatus"</span><span class="p">,</span>
                    <span class="n">ExpressionAttributeValues</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">AttributeValue</span><span class="p">&gt;()</span>
                    <span class="p">{</span>
                        <span class="p">{</span><span class="s">":DriverId"</span><span class="p">,</span> <span class="k">new</span> <span class="n">AttributeValue</span> <span class="p">{</span> <span class="n">S</span> <span class="p">=</span> <span class="s">"0993832478"</span><span class="p">}},</span>
                        <span class="p">{</span><span class="s">":OldStatus"</span><span class="p">,</span> <span class="k">new</span> <span class="n">AttributeValue</span> <span class="p">{</span> <span class="n">S</span> <span class="p">=</span> <span class="s">"Pending"</span><span class="p">}},</span>
                        <span class="p">{</span><span class="s">":NewStatus"</span><span class="p">,</span> <span class="k">new</span> <span class="n">AttributeValue</span> <span class="p">{</span> <span class="n">S</span> <span class="p">=</span> <span class="s">"InProgress"</span><span class="p">}}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre></table></code></div></div><p>В цьому коді ми виконуємо транзакцію, що скаладаєтьс з двох оновлень даних що представлені екземплярами <code class="language-plaintext highlighter-rouge">TransactWriteItem</code>. Якщо умова в <code class="language-plaintext highlighter-rouge">ConditionExpression</code> виконується - буде виконано вираз <code class="language-plaintext highlighter-rouge">UpdateExpression</code>. Для запису водія ми оновлюємо номер замовлення, якщо воно порожнє:</p><div class="language-c# highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>  <span class="n">UpdateExpression</span> <span class="p">=</span> <span class="s">"set OrderId = :OrderId"</span><span class="p">,</span>
  <span class="n">ConditionExpression</span> <span class="p">=</span> <span class="s">"attribute_not_exists(OrderId)"</span><span class="p">,</span>
</pre></table></code></div></div><p>Для запису замовлення ми оновлюємо поле водія та статус, якщо водій ще не був призначений, а статус дорівнює <code class="language-plaintext highlighter-rouge">Pending</code>:</p><div class="language-c# highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>  <span class="n">UpdateExpression</span> <span class="p">=</span> <span class="s">"set DriverId = :DriverId, OrderStatus = :NewStatus"</span><span class="p">,</span>
  <span class="n">ConditionExpression</span> <span class="p">=</span> <span class="s">"attribute_not_exists(DriverId) AND OrderStatus=:OldStatus"</span><span class="p">,</span>
</pre></table></code></div></div><p>Документація по Amazon DynamoDB досить детально описує синтаксис <a href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/Expressions.ConditionExpressions.html">умовного виразу</a> і <a href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/Expressions.UpdateExpressions.html">виразу оновлення даних</a>. Вони гарно підходять для більшості випадків.</p><p>Якщо повторно запустити даний метод він викличе помилку:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>Amazon.DynamoDBv2.Model.TransactionCanceledException: 'Transaction cancelled, please refer cancellation reasons for specific reasons [ConditionalCheckFailed, ConditionalCheckFailed]'
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">[ConditionalCheckFailed, ConditionalCheckFailed]</code> - мається на увазі, що умови в обох оновленнях не спрацювали, тому вся транзакція була відмінена.</p><p>Операція, що дозволяє водієві взяти замовлення відповідає нашим двом вимогам:</p><ul><li>вона узгоджена - замовлення та рядок водія змінюються синхронно таким чином, що водій не може взяти замовлення в іншому статусі окрім Pending. В статусі Pending замовлення завжди буде мати пов’язаного водія.<li>вона атомарна - запит або буде виконана повністю, або жодних змін до бази даних застосовуватись не буде</ul><p>Але як же ідемпотентність? Якщо повторно виконати наш метод, як ми бачили, впаде <code class="language-plaintext highlighter-rouge">TransactionCanceledException</code>. Для реалізації</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/uk/categories/%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D1%83%D0%B2%D0%B0%D0%BD%D0%BD%D1%8F/'>Програмування</a>, <a href='/uk/categories/net/'>.NET</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-tags"> <span>Популярні Теги</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/uk/tags/net/">.NET</a> <a class="post-tag" href="/uk/tags/asp-net-core/">ASP.NET Core</a> <a class="post-tag" href="/uk/tags/c/">C#</a> <a class="post-tag" href="/uk/tags/heroku/">Heroku</a> <a class="post-tag" href="/uk/tags/%D0%BF%D0%B5%D1%80%D0%B5%D0%BA%D0%BB%D0%B0%D0%B4/">переклад</a> <a class="post-tag" href="/uk/tags/acid/">ACID</a> <a class="post-tag" href="/uk/tags/aws/">AWS</a> <a class="post-tag" href="/uk/tags/codility-com/">codility.com</a> <a class="post-tag" href="/uk/tags/dynamodb/">DynamoDB</a> <a class="post-tag" href="/uk/tags/entity-framework/">Entity Framework</a></div></div></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="disqus" class="pt-2 pb-2"><p class="text-center text-muted small pb-5"> Loading comments from <a href="https://disqus.com/">Disqus</a> ...</p></div><script src="/assets/js/lib/jquery.disqusloader.min.js"></script> <script> const options = { scriptUrl: '//martyniuk.disqus.com/embed.js', disqusConfig: function() { this.page.title = ''; this.page.url = 'http://www.martyniuk.info/uk/posts/%D1%82%D1%80%D0%B0%D0%BD%D0%B7%D0%B0%D0%BA%D1%86%D1%96%D1%97-%D0%B2-dynamodb/'; this.page.identifier = '/posts/%D1%82%D1%80%D0%B0%D0%BD%D0%B7%D0%B0%D0%BA%D1%86%D1%96%D1%97-%D0%B2-dynamodb/'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/uk/tags/net/">.NET</a> <a class="post-tag" href="/uk/tags/asp-net-core/">ASP.NET Core</a> <a class="post-tag" href="/tags/c/">C#</a> <a class="post-tag" href="/uk/tags/heroku/">Heroku</a> <a class="post-tag" href="/uk/tags/%D0%BF%D0%B5%D1%80%D0%B5%D0%BA%D0%BB%D0%B0%D0%B4/">переклад</a> <a class="post-tag" href="/uk/tags/acid/">ACID</a> <a class="post-tag" href="/uk/tags/aws/">AWS</a> <a class="post-tag" href="/uk/tags/codility-com/">codility.com</a> <a class="post-tag" href="/uk/tags/dynamodb/">DynamoDB</a> <a class="post-tag" href="/uk/tags/entity-framework/">Entity Framework</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="http://www.martyniuk.info{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
